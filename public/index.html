<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <title>Live Jobber Visit List üëâüèº Markdown</title>
  <style>
		body {
			font-family: 'Roboto', sans-serif;
			background-color: #f4f6f8;
			color: #333;
			padding: 0 20px;
			/* max-width: 900px; */
			margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
		}

		h1 {
			font-size: 2rem;
			color: #1a1a1a;
			margin: 10px 0;
		}

    label {
      font-weight: bold;
    }
    input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.5);
    }
    .dates {
      display: flex;
      align-items: center;
    }
    .dates label {
      margin-right: 5px;
      flex: 2;
    }
    #startDate, #endDate {
      font-size: 16px;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #aaa;
      font-weight: bold;
      flex: 2;
    }

    #wrapper {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      flex: 1;
      min-height: 0;
    }
    #optionsContainer {
      margin-bottom: 20px;
      background: #e5e5e5;  /* Changed from pink to a more subtle color */
      margin-right: 20px;
      font-size: 0.85em;
      max-width: 300px;
      padding: 0 15px;
      border-radius: 4px;
      box-shadow: 0 0px 5px rgba(0,0,0,0.5);
    }
    #optionsContainer label {
      margin-right: 5px;
      flex: 2;
    }
    #optionsContainer select {
      flex: 2;
    }
    #optionsContainer p {
      display: flex;
      align-items: center;
    }

    #outputContainer {
      flex: 3;
      display: flex;
      gap: 20px;
      min-height: 0; /* Important for flex children to respect parent height */
      height: calc(100vh - 150px); /* Adjust based on your header/footer size */
    }

    textarea#output {
			flex: 1;
			min-height: 100px;
			font-family: monospace;
			box-sizing: border-box;
			padding: 12px;
			border: 1px solid #ccc;
			border-radius: 4px;
			resize: vertical;
			font-size: 11px;
      background-color: #e5e5e5;
      overflow: auto;
      box-shadow: 0 2px 5px inset rgba(0,0,0,0.2);
		}
    #renderedMarkdown {
      flex: 1;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.85em;
      overflow: auto;
      background-color: white;
    }
    #renderedMarkdown p {
      margin: 0;
      padding: 2px 0;
    }

		button {
			display: inline-block;
			background-color: #007bff;
			border: none;
			color: #fff;
			text-align: center;
			font-size: 1rem;
			padding: 12px 24px;
			border-radius: 4px;
			cursor: pointer;
			transition: all 0.3s;
      width: 100%;
		}

		button:hover {
			background-color: #0056b3;
		}

    select {
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #aaa;
      width: 100%;
    }
    #renderedMarkdown {
			p {
				line-height: 1.75;
			}

			code {
				padding: 1px 4px;
				background-color: #eee;
				border: 1px solid #ccc;
				border-radius: 3px;
			}
		}

    @media (max-width: 768px) {
      #wrapper {
        flex-direction: column;
      }
      
      #optionsContainer {
        max-width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
      }
      
      #outputContainer {
        flex-direction: column;
        height: auto;
        max-height: 70vh;
      }
      
      textarea#output, #renderedMarkdown {
        width: 100%;
        min-height: 200px;
      }
    }
  </style>
  <script>
    // Pre-authentication: On page load, check if the user is authenticated.
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/authenticated', { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
          throw new Error('Not authenticated');
        }
        console.log('User is authenticated');
      } catch (error) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/auth/jobber';
        return;
      }

      // Compute the next Sunday (if today is Sunday, use 7 days from now).
      function getNextSunday() {
        const now = new Date();
        const day = now.getDay(); // Sunday = 0, Monday = 1, ..., Saturday = 6
        let daysUntilSunday = (7 - day) % 7;
        if (daysUntilSunday === 0) daysUntilSunday = 0;
        const nextSunday = new Date(now);
        nextSunday.setDate(now.getDate() + daysUntilSunday);
        return nextSunday;
      }

      // Compute the Friday following the given Sunday.
      function getFollowingFriday(fromSunday) {
        const friday = new Date(fromSunday);
        friday.setDate(fromSunday.getDate() + 5); // Friday is 5 days after Sunday
        return friday;
      }

      // Format a date as YYYY-MM-DD for the date input.
      function formatDateInput(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      const nextSunday = getNextSunday();
      const followingFriday = getFollowingFriday(nextSunday);
      document.getElementById('startDate').value = formatDateInput(nextSunday);
      document.getElementById('endDate').value = formatDateInput(followingFriday);

      // Auto load fetch visits
      fetchVisits();
    });
  </script>
</head>
<body>
  <h1>Jobber Visits üëâüèº Markdown</h1>
  <p>Select a start and end date to fetch your Jobber visits. (If you aren‚Äôt logged in, you will be redirected to Jobber‚Äôs login.)</p>
  
  <div id="wrapper">
    <div id="optionsContainer">
      <p class="dates">
        <label for="startDate">Start Date:</label>
        <input type="date" id="startDate" name="startDate">
      </p>
      <p class="dates">
        <label for="endDate">End Date:</label>
        <input type="date" id="endDate" name="endDate">
      </p>      
      
      <button type="button" id="fetchButton">Fetch Visits</button>

      <p>
        <label for="sortBySelect">Sort by:</label>
        <select id="sortBySelect">
          <option value="date">Date</option>
          <option value="geoCode">GeoCode</option>
          <option value="value">$ Value</option>
          <option value="geoCodeThenValue">GeoCode, then $ Value</option>
          <option value="alphabetical">Alphabetical</option>
          <option value="salesperson">Salesperson</option>
        </select>
      </p>

      <p>
        <label for="annualSelect">Annual Jobs:</label>
        <select id="annualSelect">
          <option value="include" selected>Include Annual Jobs</option>
          <option value="none">Don't Show Annual Jobs</option>
          <option value="annualOnly">Show Only Annual Jobs</option>
          <option value="excludeUnconfirmedAnnual">Show Only Confirmed Annual Jobs</option>
        </select>
      </p>

      <p>
        <label for="showDatesSelect">Show Dates:</label>
        <select id="showDatesSelect">
          <option value="none" selected>Don't Show Dates</option>
          <option value="all">Show All Job Dates</option>
          <option value="weekdayOnly">Show Only Weekday Job Dates</option>
        </select>
      </p>
      <p><input type="checkbox" id="showValueCheckbox"><label for="showValueCheckbox">Show $ Value</label></p>
      <p><input type="checkbox" id="showSalespersonCheckbox"><label for="showSalespersonCheckbox">Show Salesperson</label></p>
      <p><input type="checkbox" id="renderMarkdownCheckbox" checked><label for="renderMarkdownCheckbox">Show Rendered Markdown</label></p>
      <p><input type="checkbox" id="showRangeStatsCheckbox" checked><label for="showRangeStatsCheckbox">Show Range Stats</label></p>
    </div>

    <div id="outputContainer">
      <div id="renderedMarkdown"></div>
      <textarea id="output" placeholder="Your Markdown will go here."></textarea>
    </div>
  </div>

  <script>
    let DATA = null;
    // Helper function to format a date string into a friendly format.
    function formatDate(dateString) {
      const date = new Date(dateString);
      const weekdayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });
      const weekday = weekdayFormatter.format(date);
      const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'numeric', day: 'numeric' });
      let formattedDate = dateFormatter.format(date);
      formattedDate = formattedDate.replace(/(\d)(:?\d{2})\s?([AaPp][Mm])/, '$1$2$3').toLowerCase();
      return `${weekday} ${formattedDate}`;
    }

    // Function to format the Jobber visits JSON into Markdown.
    function formatJobList(data) {
      const visits = data.data.visits.edges;
      
      // Sort visits based on a "geo code" extracted from the title.
      const getGeoCode = (edge) => {
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        return (titleParts && titleParts[1]) ? titleParts[1].trim() : '';
      };

      let output = '';
      const sortBySelect = document.getElementById("sortBySelect");
      const annualSelect = document.getElementById("annualSelect");
      const showDatesSelect = document.getElementById("showDatesSelect");
      const showValueCheckbox = document.getElementById("showValueCheckbox");
      const showSalespersonCheckbox = document.getElementById("showSalespersonCheckbox");
      const showRangeStatsCheckbox = document.getElementById("showRangeStatsCheckbox");

      let total = 0;
      let jobCount = 0;
      let jobLines = '';

      switch (sortBySelect.value) {
        case "geoCode":
          visits.sort((a, b) => {
            return getGeoCode(a).localeCompare(getGeoCode(b));
          });
          break;
        case "value":
          visits.sort((a, b) => {
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;
            return valueB - valueA;
          });
          showValueCheckbox.checked = true;
          break;
        case "geoCodeThenValue":
          visits.sort((a, b) => {
            const geoCodeA = getGeoCode(a);
            const geoCodeB = getGeoCode(b);
            const valueA = a.node.job.total || 0;
            const valueB = b.node.job.total || 0;

            const geoCodeComparison = geoCodeA.localeCompare(geoCodeB);
            if (geoCodeComparison !== 0) {
              return geoCodeComparison;
            } else {
              return valueB - valueA;
            }
          });
          showValueCheckbox.checked = true;
          break;
        case "alphabetical":
          visits.sort((a, b) => {
            return a.node.title.localeCompare(b.node.title);
          });
          break;
        case "salesperson":
          visits.sort((a, b) => {
            const salespersonA = a.node.job.salesperson ? a.node.job.salesperson.name.first : '';
            const salespersonB = b.node.job.salesperson ? b.node.job.salesperson.name.first : '';
            return salespersonA.localeCompare(salespersonB);
          });
          showSalespersonCheckbox.checked = true;
          break;
        case "date":
          visits.sort((a, b) => {
            return new Date(a.node.startAt) - new Date(b.node.startAt);
          });
        default:
          // Already sorted by date by default
          break;
      }
      
      // Iterate over the visits and format them.
      visits.forEach(edge => {
        const titleParts = edge.node.title.match(/(^[^-]+)|(-[A-Z]+-)|([^-\s][^-\n]*[^-\s])|(-[^-\s][^-\n]*[^-\s])/g);
        let salespersonName = edge.node.job.salesperson ? edge.node.job.salesperson.name.first.trim() : 'Unknown';
        let includingLine = true;

        const jobIdentifier = titleParts[0].trim();
        const geoCode = titleParts[1] ? titleParts[1].trim() : '?';
        const address = titleParts[2] ? titleParts[2].trim() : '?';
        const workCode = titleParts[3] ? titleParts[3].trim() : '?';
        const jobberWebUri = edge.node.job.jobberWebUri;
        const googleMapsUrl = `https://www.google.com/maps/place/${address.replace(/\s\/\s/g, '+').replace(/\s/g, '+')}+Spokane,WA`;

        if (annualSelect.value === "include") {
          includingLine = true;
        } else if (annualSelect.value === "annualOnly") {
          // Show only jobs with '=' in the identifier (annual jobs)
          if (!jobIdentifier.includes('=')) {
            includingLine = false;
          }
        } else if (annualSelect.value === "excludeUnconfirmedAnnual") {
          // Show only confirmed annual jobs (those with '=' but not starting with '=')
          if (!jobIdentifier.includes('=') || jobIdentifier.startsWith('=')) {
            includingLine = false;
          }
        } else {
          // "none" option selected - don't show annual jobs
          if (jobIdentifier.includes('=')) {
            includingLine = false;
          }
        }

        if (includingLine) {
          jobCount++;
          total += edge.node.job.total || 0;
          jobLines += `[**${jobIdentifier}**](${jobberWebUri}) ${geoCode} [${address}](${googleMapsUrl}) - ${workCode}`;
          const jobdate = formatDate(edge.node.startAt);
          if (showDatesSelect.value === "all") {
            jobLines += ` **\`${jobdate}\`**`;
          } else if (showDatesSelect.value === "weekdayOnly" && !jobdate.startsWith("Sun ")) {
            jobLines += ` **\`${jobdate}\`**`;
          }

          if (showValueCheckbox.checked) {
            jobLines += ` \`$${edge.node.job.total ? edge.node.job.total : '?'}\``;
          }

          if (showSalespersonCheckbox.checked) {
            jobLines += ` \`${salespersonName}\``;
          }
          jobLines += '\n\n';
        }
      });
      
      if (showRangeStatsCheckbox.checked) {
        output += `**\`${jobCount} Jobs\`** **\`$${total}\`**\n\n`;
      }
      
      output += jobLines;
      
      return output;
    }

    // Format and display the Markdown output.
    function formatAndDisplay() {
      const data = DATA;
      const output = document.getElementById('output');
      const markdownOutput = formatJobList(data);
      output.value = "";
      output.value = markdownOutput;
      output.select();
      output.setSelectionRange(0, 99999); /* For mobile devices */
      document.execCommand("copy");

      const markdownContainer = document.getElementById('renderedMarkdown');
      markdownContainer.innerHTML = "";

      if (document.getElementById('renderMarkdownCheckbox').checked) {
        marked.use({
          gfm: true,
          breaks: true
        });
        let markdownedHTML = marked.parse(markdownOutput);
        markdownContainer.innerHTML = markdownedHTML;
      }
    }

    // Fetch visits from the server and update the page.
    async function fetchVisits() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (!startDate || !endDate) {
        alert("Please select both start and end dates.");
        return;
      }

      // Fetch the visits from the server.
      try {
        const response = await fetch(
          `/api/visits?startDate=${encodeURIComponent(startDate + "T00:00:00")}&endDate=${encodeURIComponent(endDate + "T23:59:59")}`,
          { headers: { 'Accept': 'application/json' } }
        );

        // If not authenticated, redirect to OAuth login.
        if (response.status === 401) {
          window.location.href = '/auth/jobber';
          return;
        }

        if (!response.ok) {
          throw new Error("Network response was not ok.");
        }

        const data = await response.json();
        console.log(data);
        DATA = data;
        formatAndDisplay();
      } catch (error) {
        console.error("Error fetching visits:", error);
        alert("Error fetching visits. Please try again.");
      }
    }
    
    // Event listeners for the fetch button and checkboxes.
    document.getElementById('fetchButton').addEventListener('click', (event) => {
      event.preventDefault();
      fetchVisits();
    });
    const annualSelect = document.getElementById('annualSelect');
    annualSelect.addEventListener('change', formatAndDisplay);
    const sortBySelect = document.getElementById("sortBySelect");
    const showDatesSelect = document.getElementById("showDatesSelect");
    sortBySelect.addEventListener('change', formatAndDisplay);
    showDatesSelect.addEventListener('change', formatAndDisplay);
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', formatAndDisplay);
    });
  </script>
</body>
</html>